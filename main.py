import os  # –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π (–ø–æ–∏—Å–∫ –∏ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
import telebot  # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram API
from telebot import types  # –ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∏ –º–µ–Ω—é –≤ Telegram

# –ü–∞–ø–∫–∞, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–µ–∫—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π
TEXTS_FOLDER = "texts"

# –ü–∞–ø–∫–∞, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π –∏ –ø–æ—Ä—Ç—Ä–µ—Ç –ø–∏—Å–∞—Ç–µ–ª—è
IMAGES_FOLDER = "images"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram-–±–æ—Ç–∞ —Å –≤–∞—à–∏–º API-—Ç–æ–∫–µ–Ω–æ–º
bot = telebot.TeleBot("7553764929:AAHWsWeQ8H_EQ-bzYqLnKh5vQeXEAW5ex8Q")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
def get_main_menu():
    # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    markup = types.ReplyKeyboardMarkup()
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–µ–Ω—é
    btn1 = types.KeyboardButton("–ü–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é")
    btn2 = types.KeyboardButton("–ü–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –æ—Ç—Ä—ã–≤–∫—É –∏–ª–∏ —Å–ª–æ–≤—É")
    btn3 = types.KeyboardButton("–û —á–∞—Ç-–±–æ—Ç–µ")
    # –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
    markup.row(btn1, btn2)
    markup.row(btn3)
    return markup

# –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥ "/start", "/run", "/activate"
@bot.message_handler(commands=["start", "run", "activate"])
def send_welcome(message):
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é
    bot.send_message(
        message.chat.id,
        "<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>üëãüèº\n"
        "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –§.–ú. –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æüìñ\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        parse_mode="html",  # –£–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        reply_markup=get_main_menu()  # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    )

# –•—ç–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
@bot.message_handler(func=lambda message: message.text in ["–û —á–∞—Ç-–±–æ—Ç–µ", "–ü–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é", "–ü–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –æ—Ç—Ä—ã–≤–∫—É –∏–ª–∏ —Å–ª–æ–≤—É"])
def handle_main_menu(message):
    if message.text == "–û —á–∞—Ç-–±–æ—Ç–µ":
        # –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        bot.send_message(
            message.chat.id,
            "–≠—Ç–æ—Ç –±–æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç–æ–º –¢–ü–£ –≥—Ä—É–ø–ø—ã 8–ò42 <u>–†–µ–∑–Ω–æ–≤ –ò.–í</u> –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è—Ö –§.–ú. –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ.\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            parse_mode="html",
            reply_markup=get_main_menu()
        )
    elif message.text == "–ü–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é":
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:")
        # –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        bot.register_next_step_handler(message, search_by_name)
    elif message.text == "–ü–æ–∏—Å–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –æ—Ç—Ä—ã–≤–∫—É –∏–ª–∏ —Å–ª–æ–≤—É":
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫ –∏–ª–∏ —Å–ª–æ–≤–æ –∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞:")
        # –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—É
        bot.register_next_step_handler(message, search_by_fragment)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
def search_by_name(message):
    title = message.text  # –ü–æ–ª—É—á–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    text_path = os.path.join(TEXTS_FOLDER, f"{title}.txt")  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Ç–µ–∫—Å—Ç–∞
    image_path = os.path.join(IMAGES_FOLDER, f"{title}.jpg")  # –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    default_image_path = os.path.join(IMAGES_FOLDER, "portrait.jpg")  # –ü—É—Ç—å –∫ –ø–æ—Ä—Ç—Ä–µ—Ç—É –ø–∏—Å–∞—Ç–µ–ª—è

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª —Ç–µ–∫—Å—Ç–∞
    if os.path.exists(text_path):
        try:
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8
            with open(text_path, "r", encoding="utf-8") as file:
                path_text = file.read().split("\n")[:4]  # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 —Å—Ç—Ä–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞
                fragment = "–û—Ç—Ä—ã–≤–æ–∫ –∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:\n\n" + '\n'.join(path_text)
        except UnicodeDecodeError:
            # –ï—Å–ª–∏ UTF-8 –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É, –ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ Windows-1251
            with open(text_path, "r", encoding="windows-1251", errors="ignore") as file:
                path_text = file.read().split("\n")[:4]  # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 —Å—Ç—Ä–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞
                fragment = "–û—Ç—Ä—ã–≤–æ–∫ –∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:\n\n" + '\n'.join(path_text)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        if os.path.exists(image_path):
            # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ —Å —Ç–µ–∫—Å—Ç–æ–º
            with open(image_path, "rb") as img:
                bot.send_photo(message.chat.id, img, caption=fragment)
        else:
            # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—Ç—Ä–µ—Ç –ø–∏—Å–∞—Ç–µ–ª—è
            with open(default_image_path, "rb") as img:
                bot.send_photo(message.chat.id, img, caption=fragment)

        # –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        bot.send_message(
            message.chat.id,
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=get_main_menu()
        )
    else:
        # –ï—Å–ª–∏ —Ñ–∞–π–ª —Ç–µ–∫—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω, —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        bot.send_message(
            message.chat.id,
            "–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æü§î\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.",
            reply_markup=get_main_menu()
        )


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π –ø–æ –æ—Ç—Ä—ã–≤–∫—É –∏–ª–∏ —Å–ª–æ–≤—É
def search_by_fragment(message):
    fragment = message.text.lower()  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –µ–≥–æ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    results = []  # –°–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, –≥–¥–µ –Ω–∞–π–¥–µ–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç

    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º –≤ –ø–∞–ø–∫–µ —Å —Ç–µ–∫—Å—Ç–∞–º–∏
    for filename in os.listdir(TEXTS_FOLDER):
        if filename.endswith(".txt"):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç .txt
            file_path = os.path.join(TEXTS_FOLDER, filename)
            try:
                # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8
                with open(file_path, "r", encoding="utf-8") as file:
                    content = file.read().lower()  # –ß–∏—Ç–∞–µ–º –∏ –ø—Ä–∏–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
            except UnicodeDecodeError:
                # –ï—Å–ª–∏ UTF-8 –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É, –ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ Windows-1251
                with open(file_path, "r", encoding="windows-1251", errors="ignore") as file:
                    content = file.read().lower()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤ —Ç–µ–∫—Å—Ç–µ
            if fragment in content:
                # –ï—Å–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è .txt) –≤ —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                results.append(filename.replace(".txt", ""))

    # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    if results:
        bot.send_message(
            message.chat.id,
            f"–§—Ä–∞–≥–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω –≤ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏(-—è—Ö): {', '.join(results)}",
            reply_markup=get_main_menu()
        )
    else:
        # –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
        bot.send_message(
            message.chat.id,
            "–§—Ä–∞–≥–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç.",
            reply_markup=get_main_menu()
        )


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
bot.infinity_polling()